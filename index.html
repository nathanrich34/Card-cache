<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rich Family Card Cache</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.0/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #1e3a8a, #ffffff);
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .btn {
            transition: background-color 0.3s;
        }
        .btn:hover {
            filter: brightness(110%);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hot { color: red; font-weight: bold; }
        .cold { color: blue; font-weight: bold; }
        .player-link { color: #1e3a8a; text-decoration: underline; cursor: pointer; }
        .player-link:hover { color: #2563eb; }
    </style>
</head>
<body class="font-sans min-h-screen">
    <div class="max-w-5xl mx-auto p-6">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-white">Rich Family Card Cache</h1>
            <p class="text-white">Your Familyâ€™s Baseball Card Collection</p>
        </header>

        <!-- Scan Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-2xl font-bold mb-4">Scan or Add a Card</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="scanButton" class="btn bg-blue-600 text-white p-2 rounded">Scan with Camera</button>
                <button id="manualEntryButton" class="btn bg-green-600 text-white p-2 rounded">Add Manually</button>
            </div>
            
            <!-- This container is important for positioning the camera view and capture button -->
            <div id="videoContainer" class="relative w-full max-w-md mx-auto">
                <video id="video" class="hidden w-full"></video>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
            <p id="scanStatus" class="text-gray-600 mt-2 text-center"></p>

            <!-- Manual Entry Form (Hidden by Default) -->
            <div id="manualEntryForm" class="hidden mt-4">
                <h3 class="text-lg font-bold mb-2">Manual Card Entry</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input id="manualName" type="text" placeholder="Card Name" class="border p-2 rounded">
                    <input id="manualPlayer" type="text" placeholder="Player" class="border p-2 rounded">
                    <input id="manualYear" type="number" placeholder="Year" class="border p-2 rounded">
                    <input id="manualValue" type="number" placeholder="Value ($)" class="border p-2 rounded">
                    <select id="manualCondition" class="border p-2 rounded">
                        <option value="Unknown">Select Condition</option>
                        <option value="Mint">Mint</option>
                        <option value="Near Mint">Near Mint</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                    </select>
                    <select id="manualPopularity" class="border p-2 rounded">
                        <option value="Unknown">Select Popularity</option>
                        <option value="Hot">Hot</option>
                        <option value="Cold">Cold</option>
                    </select>
                    <input id="manualRecommendation" type="text" placeholder="Recommendation" class="border p-2 rounded">
                </div>
                <button id="submitManual" class="btn bg-blue-600 text-white p-2 rounded mt-4">Submit</button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-2xl font-bold mb-4">Filter Collection</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <input id="filterPlayer" type="text" placeholder="Filter by Player" class="border p-2 rounded">
                <input id="filterYear" type="number" placeholder="Filter by Year" class="border p-2 rounded">
                <select id="filterPopularity" class="border p-2 rounded">
                    <option value="">All Popularity</option>
                    <option value="Hot">Hot</option>
                    <option value="Cold">Cold</option>
                </select>
                <input id="filterValueMin" type="number" placeholder="Min Value ($)" class="border p-2 rounded">
                <input id="filterValueMax" type="number" placeholder="Max Value ($)" class="border p-2 rounded">
                <select id="filterCondition" class="border p-2 rounded">
                    <option value="">All Conditions</option>
                    <option value="Mint">Mint</option>
                    <option value="Near Mint">Near Mint</option>
                    <option value="Excellent">Excellent</option>
                    <option value="Good">Good</option>
                </select>
            </div>
            <button id="applyFilters" class="btn bg-blue-600 text-white p-2 rounded mt-4">Apply Filters</button>
            <button id="clearFilters" class="btn bg-gray-600 text-white p-2 rounded mt-4">Clear Filters</button>
        </div>

        <!-- Collection Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-2xl font-bold mb-4">Card Collection</h2>
            <button id="exportCSV" class="btn bg-green-600 text-white p-2 rounded mb-4">Export to CSV</button>
            <table id="cardTable" class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2">Card Name</th>
                        <th class="border p-2">Player</th>
                        <th class="border p-2">Year</th>
                        <th class="border p-2">Value</th>
                        <th class="border p-2">Condition</th>
                        <th class="border p-2">Popularity</th>
                        <th class="border p-2">Recommendation</th>
                        <th class="border p-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="cardTableBody"></tbody>
            </table>
            <p id="totalValue" class="mt-4 font-bold"></p>
            <p id="duplicateWarning" class="mt-2 text-red-600"></p>
        </div>
    </div>

<script>
    // --- STATE MANAGEMENT ---
    // Load collection from localStorage. This is where your saved cards live.
    let collection = JSON.parse(localStorage.getItem('cardCollection')) || [];

    // --- DOM ELEMENTS ---
    // Getting references to all the HTML elements we'll need to interact with.
    const scanButton = document.getElementById('scanButton');
    const manualEntryButton = document.getElementById('manualEntryButton');
    const manualEntryForm = document.getElementById('manualEntryForm');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const scanStatus = document.getElementById('scanStatus');

    // --- CORE FUNCTIONS ---

    /**
     * Toggles the visibility of the manual entry form.
     */
    function toggleManualEntryForm() {
        manualEntryForm.classList.toggle('hidden');
    }

    /**
     * Initializes the camera to capture a photo for OCR.
     */
    async function initializeCamera() {
        scanStatus.textContent = 'Starting camera...';
        video.classList.remove('hidden');

        const videoContainer = document.getElementById('videoContainer');

        // Create a 'Take Photo' button dynamically over the video feed
        let captureButton = document.getElementById('captureButton');
        if (!captureButton) {
            captureButton = document.createElement('button');
            captureButton.id = 'captureButton';
            captureButton.textContent = 'Take Photo';
            captureButton.className = 'btn bg-red-600 text-white p-3 rounded-full absolute bottom-4 left-1/2 -translate-x-1/2 shadow-lg';
            videoContainer.appendChild(captureButton);

            captureButton.addEventListener('click', () => {
                captureImageAndProcess();
                stopCamera();
            });
        }
        
        try {
            // Request the rear camera ('environment') on mobile devices
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            await video.play();
            scanStatus.textContent = 'Camera ready. Position the card and take a photo.';
        } catch (err) {
            console.error("Camera Error:", err);
            scanStatus.textContent = 'Could not access camera. Please grant permission and try again.';
            stopCamera();
        }
    }

    /**
     * Captures a frame from the video, displays it on the canvas,
     * and runs the OCR process.
     */
    async function captureImageAndProcess() {
        scanStatus.textContent = 'Processing image... this may take a moment.';
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Run OCR on the captured image
        const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
            logger: m => {
                console.log(m); // Logs progress to the console
                if (m.status === 'recognizing text') {
                    scanStatus.textContent = `Analyzing... ${Math.round(m.progress * 100)}%`;
                }
            }
        });
        
        scanStatus.textContent = 'Text extracted! Please verify the details below.';
        prefillManualForm(text);
    }
    
    /**
     * Uses extracted text to intelligently pre-fill the manual entry form.
     */
    function prefillManualForm(text) {
        // Simple regex to find a four-digit year (e.g., 1998, 2023)
        const yearMatch = text.match(/\b(19|20)\d{2}\b/);
        if (yearMatch) {
            document.getElementById('manualYear').value = yearMatch[0];
        }

        // A very basic attempt to find a player's name (often capitalized)
        const nameMatch = text.match(/([A-Z][a-z]+)\s([A-Z][a-z]+)/);
        if (nameMatch) {
            document.getElementById('manualPlayer').value = nameMatch[0];
        }
        
        // Put the rest of the relevant text into the card name field for review
        document.getElementById('manualName').value = text.replace(/\n/g, ' ').trim();

        // Show the form so the user can verify the pre-filled data
        manualEntryForm.classList.remove('hidden');
    }

    /**
     * Stops the camera stream and hides the video element and capture button.
     */
    function stopCamera() {
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        video.classList.add('hidden');
        const captureButton = document.getElementById('captureButton');
        if (captureButton) {
            captureButton.remove();
        }
    }

    /**
     * Adds a new card to the collection from the manual form.
     */
    function submitManualCard() {
        const card = {
            id: Date.now(), // Add a unique ID for better management
            name: document.getElementById('manualName').value,
            player: document.getElementById('manualPlayer').value,
            year: parseInt(document.getElementById('manualYear').value) || 0,
            value: parseFloat(document.getElementById('manualValue').value) || 0,
            condition: document.getElementById('manualCondition').value || 'Unknown',
            popularity: document.getElementById('manualPopularity').value || 'Unknown',
            recommendation: document.getElementById('manualRecommendation').value || 'None'
        };

        if (card.name && card.player && card.year) {
            addCardToCollection(card);
            scanStatus.textContent = 'Card added successfully!';
            manualEntryForm.classList.add('hidden');
            // Clear the form after submission
            manualEntryForm.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
                if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
            });
        } else {
            scanStatus.textContent = 'Please fill in Name, Player, and Year.';
        }
    }

    /**
     * Adds a card object to the collection array and updates storage/UI.
     */
    function addCardToCollection(card) {
        // Check for duplicates before adding
        const isDuplicate = collection.some(c => c.name === card.name && c.player === card.player);
        const duplicateWarning = document.getElementById('duplicateWarning');
        if (isDuplicate) {
            duplicateWarning.textContent = `Warning: This card may already be in your collection.`;
        } else {
             duplicateWarning.textContent = '';
        }
        
        collection.push(card);
        localStorage.setItem('cardCollection', JSON.stringify(collection));
        updateTable();
    }

    /**
     * Deletes a card from the collection using its unique ID.
     */
    function deleteCard(cardId) {
        collection = collection.filter(card => card.id !== cardId);
        localStorage.setItem('cardCollection', JSON.stringify(collection));
        updateTable();
    }
    
    /**
     * Updates the HTML table with the current card collection.
     */
    function updateTable(filteredCollection = collection) {
        const tbody = document.getElementById('cardTableBody');
        tbody.innerHTML = '';
        let totalValue = 0;

        filteredCollection.forEach(card => {
            totalValue += parseFloat(card.value) || 0;
            const row = document.createElement('tr');
            row.className = 'card fade-in';
            row.innerHTML = `
                <td class="border p-2">${card.name}</td>
                <td class="border p-2"><a href="player_trends.html?player=${encodeURIComponent(card.player)}" class="player-link">${card.player}</a></td>
                <td class="border p-2">${card.year}</td>
                <td class="border p-2">$${(parseFloat(card.value) || 0).toFixed(2)}</td>
                <td class="border p-2">${card.condition}</td>
                <td class="border p-2 ${card.popularity.toLowerCase()}">${card.popularity}</td>
                <td class="border p-2">${card.recommendation}</td>
                <td class="border p-2">
                    <button onclick="deleteCard(${card.id})" class="btn bg-red-600 text-white p-1 rounded">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('totalValue').textContent = `Total Collection Value: $${totalValue.toFixed(2)}`;
    }

    // --- EVENT LISTENERS ---
    // This runs when the page is fully loaded.
    document.addEventListener('DOMContentLoaded', () => {
        scanButton.addEventListener('click', initializeCamera);
        manualEntryButton.addEventListener('click', toggleManualEntryForm);
        document.getElementById('submitManual').addEventListener('click', submitManualCard);
        
        document.getElementById('applyFilters').addEventListener('click', () => {
            const player = document.getElementById('filterPlayer').value.toLowerCase();
            const year = parseInt(document.getElementById('filterYear').value) || null;
            const popularity = document.getElementById('filterPopularity').value;
            const valueMin = parseFloat(document.getElementById('filterValueMin').value) || null;
            const valueMax = parseFloat(document.getElementById('filterValueMax').value) || null;
            const condition = document.getElementById('filterCondition').value;

            const filteredCollection = collection.filter(card => {
                return (
                    (!player || card.player.toLowerCase().includes(player)) &&
                    (!year || card.year === year) &&
                    (!popularity || card.popularity === popularity) &&
                    (!valueMin || (parseFloat(card.value) || 0) >= valueMin) &&
                    (!valueMax || (parseFloat(card.value) || 0) <= valueMax) &&
                    (!condition || card.condition === condition)
                );
            });
            updateTable(filteredCollection);
        });

        document.getElementById('clearFilters').addEventListener('click', () => {
            document.getElementById('filterPlayer').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterPopularity').value = '';
            document.getElementById('filterValueMin').value = '';
            document.getElementById('filterValueMax').value = '';
            document.getElementById('filterCondition').value = '';
            updateTable();
        });

        document.getElementById('exportCSV').addEventListener('click', () => {
            const headers = ['Card Name', 'Player', 'Year', 'Value', 'Condition', 'Popularity', 'Recommendation'];
            const rows = collection.map(card => [
                `"${card.name.replace(/"/g, '""')}"`,
                `"${card.player}"`,
                card.year,
                (parseFloat(card.value) || 0).toFixed(2),
                `"${card.condition}"`,
                `"${card.popularity}"`,
                `"${card.recommendation}"`
            ]);
            const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'card_collection.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Initial table load
        updateTable(); 
    });
</script>
</body>
</html>
