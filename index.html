<script>
    // --- STATE MANAGEMENT ---
    // Load collection from localStorage. This is where your saved cards live.
    let collection = JSON.parse(localStorage.getItem('cardCollection')) || [];

    // --- DOM ELEMENTS ---
    // Getting references to all the HTML elements we'll need to interact with.
    const scanButton = document.getElementById('scanButton');
    const manualEntryButton = document.getElementById('manualEntryButton');
    const manualEntryForm = document.getElementById('manualEntryForm');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const scanStatus = document.getElementById('scanStatus');
    const videoContainer = document.getElementById('videoContainer'); // You'll need to add this div in your HTML

    // --- CORE FUNCTIONS ---

    /**
     * Toggles the visibility of the manual entry form.
     */
    function toggleManualEntryForm() {
        manualEntryForm.classList.toggle('hidden');
    }

    /**
     * Initializes the camera to capture a photo for OCR.
     * This replaces the barcode-focused implementation.
     */
    async function initializeCamera() {
        scanStatus.textContent = 'Starting camera...';
        video.classList.remove('hidden');

        // Create a container for the video and button to manage them easily
        if (!document.getElementById('videoContainer')) {
            const container = document.createElement('div');
            container.id = 'videoContainer';
            container.className = 'relative w-full max-w-md mx-auto';
            video.parentNode.insertBefore(container, video);
            container.appendChild(video);
        }

        // Create a 'Take Photo' button dynamically over the video feed
        let captureButton = document.getElementById('captureButton');
        if (!captureButton) {
            captureButton = document.createElement('button');
            captureButton.id = 'captureButton';
            captureButton.textContent = 'Take Photo';
            captureButton.className = 'btn bg-red-600 text-white p-3 rounded-full absolute bottom-4 left-1/2 -translate-x-1/2 shadow-lg';
            video.parentElement.appendChild(captureButton);

            captureButton.addEventListener('click', () => {
                captureImageAndProcess();
                stopCamera();
            });
        }
        
        try {
            // Request the rear camera ('environment') on mobile devices
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            video.play();
            scanStatus.textContent = 'Camera ready. Position the card and take a photo.';
        } catch (err) {
            console.error("Camera Error:", err);
            scanStatus.textContent = 'Could not access camera. Please grant permission and try again.';
            stopCamera();
        }
    }

    /**
     * Captures a frame from the video, displays it on the canvas,
     * and runs the OCR process.
     */
    async function captureImageAndProcess() {
        scanStatus.textContent = 'Processing image... this may take a moment.';
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Run OCR on the captured image
        const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
            logger: m => {
                console.log(m); // Logs progress to the console
                if (m.status === 'recognizing text') {
                    scanStatus.textContent = `Analyzing... ${Math.round(m.progress * 100)}%`;
                }
            }
        });
        
        scanStatus.textContent = 'Text extracted! Please verify the details below.';
        prefillManualForm(text);
    }
    
    /**
     * Uses extracted text to intelligently pre-fill the manual entry form.
     * This is more flexible than searching for specific names.
     */
    function prefillManualForm(text) {
        // Simple regex to find a four-digit year (e.g., 1998, 2023)
        const yearMatch = text.match(/\b(19|20)\d{2}\b/);
        if (yearMatch) {
            document.getElementById('manualYear').value = yearMatch[0];
        }

        // A very basic attempt to find a player's name (often capitalized)
        const nameMatch = text.match(/([A-Z][a-z]+)\s([A-Z][a-z]+)/);
        if (nameMatch) {
            document.getElementById('manualPlayer').value = nameMatch[0];
        }
        
        // Put the rest of the relevant text into the card name field for review
        document.getElementById('manualName').value = text.replace(/\n/g, ' ').trim();

        // Show the form so the user can verify the pre-filled data
        manualEntryForm.classList.remove('hidden');
    }

    /**
     * Stops the camera stream and hides the video element and capture button.
     */
    function stopCamera() {
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        video.classList.add('hidden');
        const captureButton = document.getElementById('captureButton');
        if (captureButton) {
            captureButton.remove();
        }
    }

    /**
     * Adds a new card to the collection from the manual form.
     */
    function submitManualCard() {
        const card = {
            id: Date.now(), // Add a unique ID for better management
            name: document.getElementById('manualName').value,
            player: document.getElementById('manualPlayer').value,
            year: parseInt(document.getElementById('manualYear').value) || 0,
            value: parseFloat(document.getElementById('manualValue').value) || 0,
            condition: document.getElementById('manualCondition').value || 'Unknown',
            popularity: document.getElementById('manualPopularity').value || 'Unknown',
            recommendation: document.getElementById('manualRecommendation').value || 'None'
        };

        if (card.name && card.player && card.year) {
            addCardToCollection(card);
            scanStatus.textContent = 'Card added successfully!';
            manualEntryForm.classList.add('hidden');
            // Clear the form after submission
            manualEntryForm.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
                if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
            });
        } else {
            scanStatus.textContent = 'Please fill in Name, Player, and Year.';
        }
    }

    /**
     * Adds a card object to the collection array and updates storage/UI.
     */
    function addCardToCollection(card) {
        // Check for duplicates before adding
        const isDuplicate = collection.some(c => c.name === card.name && c.player === card.player);
        const duplicateWarning = document.getElementById('duplicateWarning');
        if (isDuplicate) {
            duplicateWarning.textContent = `Warning: This card may already be in your collection.`;
        } else {
             duplicateWarning.textContent = '';
        }
        
        collection.push(card);
        localStorage.setItem('cardCollection', JSON.stringify(collection));
        updateTable();
    }

    /**
     * Deletes a card from the collection using its unique ID.
     */
    function deleteCard(cardId) {
        collection = collection.filter(card => card.id !== cardId);
        localStorage.setItem('cardCollection', JSON.stringify(collection));
        updateTable();
    }
    
    /**
     * Updates the HTML table with the current card collection.
     */
    function updateTable(filteredCollection = collection) {
        const tbody = document.getElementById('cardTableBody');
        tbody.innerHTML = '';
        let totalValue = 0;

        filteredCollection.forEach(card => {
            totalValue += card.value;
            const row = document.createElement('tr');
            row.className = 'card fade-in';
            // Note the change in the deleteCard function call
            row.innerHTML = `
                <td class="border p-2">${card.name}</td>
                <td class="border p-2"><a href="player_trends.html?player=${encodeURIComponent(card.player)}" class="player-link">${card.player}</a></td>
                <td class="border p-2">${card.year}</td>
                <td class="border p-2">$${card.value.toFixed(2)}</td>
                <td class="border p-2">${card.condition}</td>
                <td class="border p-2 ${card.popularity.toLowerCase()}">${card.popularity}</td>
                <td class="border p-2">${card.recommendation}</td>
                <td class="border p-2">
                    <button onclick="deleteCard(${card.id})" class="btn bg-red-600 text-white p-1 rounded">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('totalValue').textContent = `Total Collection Value: $${totalValue.toFixed(2)}`;
    }

    // --- EVENT LISTENERS ---
    // This runs when the page is fully loaded.
    document.addEventListener('DOMContentLoaded', () => {
        scanButton.addEventListener('click', initializeCamera);
        manualEntryButton.addEventListener('click', toggleManualEntryForm);
        document.getElementById('submitManual').addEventListener('click', submitManualCard);
        
        // Add listeners for filter buttons
        document.getElementById('applyFilters').addEventListener('click', () => {
            const player = document.getElementById('filterPlayer').value.toLowerCase();
            const year = parseInt(document.getElementById('filterYear').value) || null;
            const popularity = document.getElementById('filterPopularity').value;
            const valueMin = parseFloat(document.getElementById('filterValueMin').value) || null;
            const valueMax = parseFloat(document.getElementById('filterValueMax').value) || null;
            const condition = document.getElementById('filterCondition').value;

            const filteredCollection = collection.filter(card => {
                return (
                    (!player || card.player.toLowerCase().includes(player)) &&
                    (!year || card.year === year) &&
                    (!popularity || card.popularity === popularity) &&
                    (!valueMin || card.value >= valueMin) &&
                    (!valueMax || card.value <= valueMax) &&
                    (!condition || card.condition === condition)
                );
            });
            updateTable(filteredCollection);
        });

        document.getElementById('clearFilters').addEventListener('click', () => {
            document.getElementById('filterPlayer').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterPopularity').value = '';
            document.getElementById('filterValueMin').value = '';
            document.getElementById('filterValueMax').value = '';
            document.getElementById('filterCondition').value = '';
            updateTable();
        });

        // Add listener for CSV export
        document.getElementById('exportCSV').addEventListener('click', () => {
            const headers = ['Card Name', 'Player', 'Year', 'Value', 'Condition', 'Popularity', 'Recommendation'];
            const rows = collection.map(card => [
                `"${card.name.replace(/"/g, '""')}"`, // Handle quotes in names
                `"${card.player}"`,
                card.year,
                card.value.toFixed(2),
                `"${card.condition}"`,
                `"${card.popularity}"`,
                `"${card.recommendation}"`
            ]);
            const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'card_collection.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Initial table load
        updateTable(); 
    });

    // Note: The sortTable function from your original code can be added here if you wish.
</script>
</body>
</html>
